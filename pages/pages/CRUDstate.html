<template>
  <div class="page" data-name="CRUDstate">
    <div class="navbar">
      <div class="navbar-inner sliding">
        <div class="left">
          <a href="#" class="link back">
            <i class="icon icon-back"></i>
            <span class="ios-only">Back</span>
          </a>
        </div>
        <div class="title">CRUDstate ${listado} </div>
      </div>
    </div>
    <div class="page-content">
      <div class="block-title">About My App F7 : ${app.version} ${listado}</div>
      <div class="block block-strong">
        <div class="block">
          <div class="row">
            <button @click=${newrec} class="col button button-fill">Add New</button>
            <button @click=${findrecs} class="col button button-fill">Search</button>
            <button @click=${createidx} class="col button button-fill">IDX</button>
            <button @click=${bulkrecs} class="col button button-fill button-round">Bulk</button>
            <button @click=${loadrecs} class="col button button-fill button-round">Load</button>
            <button @click=${getalldocs} class="col button button-fill button-round">GetDocs</button>
            <button @click=${deletedb} class="col button button-fill button-round">DeleteDB</button>
            <button @click=${createdb} class="col button button-fill button-round">CreateDB</button>
            <!-- <button @click="$root.helloWorld" id="bnw" class="col button button-fill button-round color-red">HW</button> -->
          </div>
        </div>

        <button @click=${() => openAlert(15)}>Button</button>
        <button @click=${() => openAlert2(25)}>Button</button>

        <button class="col button search">search</button>
        <div class="w3-container">

          <div id="id01" class="w3-modal w3-animate-opacity">
            <div class="w3-modal-content w3-card-4 " style="width:100%">
              <header class="w3-container w3-teal">

                <span @click=${changeattr} class="w3-button w3-large w3-display-topright" >
                    X
                </span>

                <h2>Modal Header</h2>
              </header>
              <div class="w3-container">
                <h1>${listado}</h1>
                <!-- <div id="formarr"></div> -->

                <button @click=${() => changeattr()}>close form</button>
                <form class="list" id="my-form">
                  <ul>

                    <li>
                      <div class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">id</div>
                          <div class="item-input-wrap">
                            <input type="hidden"  name="_id" placeholder="ID" readonly />
                          </div>
                        </div>
                      </div>
                    </li>
                    <li>
                      <div class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">rev</div>
                          <div class="item-input-wrap">
                            <input type="text" name="_rev" placeholder="REV" readonly />
                          </div>
                        </div>
                      </div>
                    </li>
                    <li>
                      <div class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">Montos</div>
                          <div class="item-input-wrap">
                            <input type="text" name="montosx" placeholder="Montos" />
                          </div>
                        </div>
                      </div>
                    </li>
                    <li>
                      <div class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">FirstName</div>
                          <div class="item-input-wrap">
                            <input type="text" name="first_name" placeholder="Your name" />
                          </div>
                        </div>
                      </div>
                    </li>
                    <li>
                      <div class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">LastName</div>
                          <div class="item-input-wrap">
                            <input type="text" name="last_name" placeholder="Your name" />
                          </div>
                        </div>
                      </div>
                    </li>
                    <li>
                      <div class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">E-mail</div>
                          <div class="item-input-wrap">
                            <input type="email" name="email" placeholder="E-mail" />
                          </div>
                        </div>
                      </div>
                    </li>
                    <li>
                      <div class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">FiniAno</div>
                          <div class="item-input-wrap">
                            <input type="email" name="finiano" placeholder="E-mail" />
                          </div>
                        </div>
                      </div>
                    </li>
                    <li>
                      <div class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">FiniMes</div>
                          <div class="item-input-wrap">
                            <input type="email" name="finimes" placeholder="E-mail" />
                          </div>
                        </div>
                      </div>
                    </li>
                    <li>
                      <div class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">FiniDia</div>
                          <div class="item-input-wrap">
                            <input type="email" name="finidia" placeholder="E-mail" />
                          </div>
                        </div>
                      </div>
                    </li>
                    <li>
                      <div class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">Gender</div>
                          <div class="item-input-wrap">
                            <select name="gender">
                              <option value="male" selected>Male</option>
                              <option value="female">Female</option>
                            </select>
                          </div>
                        </div>
                      </div>
                    </li>
                    <li>
                      <div class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">Gender</div>
                          <div class="item-input-wrap">
                            <select name="gender">
                              <option value="male" selected>Male</option>
                              <option value="female">Female</option>
                            </select>
                          </div>
                        </div>
                      </div>
                    </li>
                    <li>
                      <div class="item-content">
                        <div class="item-inner">
                          <div class="item-title">Toggle</div>
                          <div class="item-after">
                            <label class="toggle toggle-init">
                              <input type="checkbox" name="toggle" value="yes" /><i class="toggle-icon"></i>
                            </label>
                          </div>
                        </div>
                      </div>
                    </li>
                  </ul>
                  <div id="formarr"></div>

                </form>



                <p>Some text..</p>
                <span class="button" @click=${() => removerec($store.state.index)}>Remove Record</span>
                <span class="button" @click=${() => updaterec($store.state.index)}>Save Record</span>
                <footer class="w3-container w3-teal">
                  <p>Modal Footer</p>
                </footer>
              </div>
            </div>
          </div>
          <!-- Each "cells" row should be wrapped with div class="row" -->
          <div class="row">
            <!-- Each "cell" has col-[widht in percents] class -->
            <div class="col-100">

              <div class="list simple-list">
                <ul>

                  ${vitems.map((xvitem, index) => $h`
                  <li>
                    <a  @click=${() => openform(index)}>
                      ${index}--
                      ${xvitem.first_name}--
                      ${xvitem.last_name}--
                      ${xvitem.email}--
                    </a>
                  </li>
                  `)}

                </ul>
              </div>
            </div>

          </div>

          <p>Fugiat perspiciatis excepturi, soluta quod non ullam deleniti. Nobis sint nemo
            consequuntur, fugiat. Eius perferendis animi autem incidunt vel quod tenetur nostrum, voluptate omnis quasi
            quidem illum consequuntur, a, quisquam.</p>
          <p>Laudantium neque magnam vitae nemo quam commodi, in cum dolore obcaecati laborum, excepturi harum, optio
            qui, consequuntur? Obcaecati dolor sequi nesciunt culpa quia perspiciatis, reiciendis ex debitis, ut tenetur
            alias.</p>
        </div>
        <div class="block">
          <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Magni molestiae laudantium dignissimos est nobis
            delectus nemo ea alias voluptatum architecto, amet similique, saepe iste consectetur in repellat ut minus
            quibusdam!</p>
          <p>Molestias et distinctio porro nesciunt ratione similique, magni doloribus, rerum nobis, aliquam quae
            reiciendis quasi modi. Nam a recusandae, fugiat in ea voluptates fuga eius, velit corrupti reprehenderit
            dignissimos consequatur!</p>
          <p>Blanditiis, cumque quo adipisci. Molestiae, dolores dolorum quos doloremque ipsa ullam eligendi commodi
            deserunt doloribus inventore magni? Ea mollitia veniam nostrum nihil, iusto doloribus a at! Ea molestiae
            ullam delectus!</p>
        </div>
      </div>
    </div>
  </div>
</template>
<script>
  //debugger;
  export default (props, { $f7, $on, $store, $update }) => {
    // -------------------------------------------------------

    // Component Data
    var $ = Dom7;
    var vitems = $store.state.vitems;
    var alqsdata = $store.state.alqsdata;
    //debugger
    var listado = 'Datos de Inquilino';
    //var index = 0;

    console.log('init comp');
    //debugger

    const changeattr = () => {
      console.log('init chgattr');
      document.getElementById('id01').style.display='none'
    };

    const openAlert = (x) => {
      console.log('init component',x);
      //$f7.dialog.alert('Hello world!8888');
    };

    const openAlert0 = (xxx) => {
      //debugger;
      var self = this;
      //app.dialog.alert(xxx);
      self.$app.dialog.alert(app.version);
      listado = xxx
      $update();
    };

    const openAlert2 = (xxx) => {
      $f7.dialog.alert('Hello world!8888'+ xxx);
    };

    const openAlert3 = (xxx) => {
      var self = this;
      db.compact().then(function (info) {
        self.$app.dialog.alert(xxx);
        // compaction complete
      }).catch(function (err) {
        // handle errors
      });
    };

    const openform = (index) => {
      // var self = this;
      //debugger;
      $store.state.index = index
      console.log('vitems[index] on openform',vitems[index])
      record = vitems[index]

      function textBoxCreate(d) {

        output = '';
        output += '<div class="card data-table  data-table-init">'
        output += '<div class="card-content">'
        output += '<table>'
        output += '<thead>'
        output += '<tr>'
        output += '<th class="label-cell">Year</th>'
        output += '<th class="numeric-cell">Month</th>'
        output += '<th class="numeric-cell">ALQS</th>'
        output += '<th class="numeric-cell">AYSS</th>'
        output += '<th class="numeric-cell">ABLS</th>'
        output += '<th class="numeric-cell">HONS</th>'
        output += '<th class="numeric-cell">IMBS</th>'
        output += '<th class="numeric-cell">FIXS</th>'
        output += '</tr>'
        output += '</thead>'

        output += '<tbody>'

        for (ii = 0; ii < 24; ++ii) {
          mes = textomes[d.getMonth()]

          output += '<tr>'
          output += '<td class="label-cell">'
          output += d.getFullYear() + '/' + (d.getMonth() + 1)
          output += '</td>'
          output += '<td class="numeric-cell">'
          output += '  ' + mes + '/' + ii
          output += '</td>'

          d.setMonth(d.getMonth() + 1);

          output += '<td class="numeric-cell">'
          output += '<input style="display: inline;width: 10 px;border: 1px solid #cfcfcf;" type="text" name="alq' + ii + '" placeholder="ALQS">'
          output += '</td>'
          output += '<td class="numeric-cell">'
          output += '<input style="display: inline;width: 10 px;border: 1px solid #cfcfcf;" type="text" name="ays' + ii + '" placeholder="AYSS">'
          output += '</td>'
          output += '<td class="numeric-cell">'
          output += '<input style="display: inline;width: 10 px;border: 1px solid #cfcfcf;" type="text" name="abl' + ii + '" placeholder="ABLS">'
          output += '</td>'
          output += '<td class="numeric-cell">'
          output += '<input style="display: inline;width: 10 px;border: 1px solid #cfcfcf;" type="text" name="hon' + ii + '" placeholder="HONS">'
          output += '</td>'
          output += '<td class="numeric-cell">'
          output += '<input style="display: inline;width: 10 px;border: 1px solid #cfcfcf;" type="text" name="imb' + ii + '" placeholder="IMBS">'
          output += '</td>'
          output += '<td class="numeric-cell">'
          output += '<input style="display: inline;width: 10 px;border: 1px solid #cfcfcf;" type="text" name="fix' + ii + '" placeholder="FIXS">'
          output += '</td>'
          output += '</tr>'
        }
        output += '</tbody>'
        output += '</table>'
        output += '</div>'
        output += '</div>'
      }

      //alert(JSON.stringify(index));
      //recindex = index
      //fini = record.fechaini;

      finiano = record.finiano;
      finimes = record.finimes;
      finidia = record.finidia;
      fini = finiano + ',' + finimes + ',' + finidia

      // < !-- var str = fini; -->
      // < !-- var ano = str.substring(0, 4); -->
      // < !-- var mes = str.substring(5, 7); -->
      // < !-- var dia = str.substring(8, 10); -->

      console.log('record on openform ',record)

      //console.log(index.montosx)
      //index.montosx = index.montos.alq[23]
      //console.log(index.montosx)

      var d = new Date(fini); //ymd julio (7) = 6

      console.log('findia ',fini)
      console.log('new date ',d)
      //console.log(fini[0])
      //console.log(fini[1])
      //console.log(fini[2])
      //
      textBoxCreate(d)
      document.getElementById('formarr').innerHTML = output;

      app.form.fillFromData('#my-form', record);
      document.getElementById('id01').style.display = 'block';

    };

    const updaterec = (index) => {
      //index= $store.state.index;
      console.log('Updating record',index )
      recindex = vitems[index]
      var formData = app.form.convertToData('#my-form');
      //alert(JSON.stringify(formData));
      var index = _.merge(recindex, formData);
      console.log(index,'recindex')
      db.put(index);
      showTodos()
      document.getElementById('id01').style.display = 'none'
    };

    const removerec = (indexxx) => {
      var formData = app.form.convertToData('#my-form');
      console.log(formData)
      index = formData;
      //var self = this;
      //self.$app.dialog.alert(JSON.stringify(index));
      db.remove(index);
      //db.remove(index._id, index._rev);
      showTodos();
      document.getElementById('id01').style.display = 'none'
    };

    const newrec = () => {
      document.getElementById("my-form").reset();
      var formData = {
        _id: new Date().toISOString(),
      }
      app.form.fillFromData('#my-form', formData);
      document.getElementById('id01').style.display = 'block'
    };

    const bulkrecs = () => {
      db.bulkDocs(alqsdata).then(function (result) {
        // handle result
        console.log('bulk data has  been loaded',result);
      }).catch(function (err) {
        console.log(err);
      });
    };


    const loadrecs = () => {
      var db = new PouchDB('alqs');
      db.load('./pages/dump.txt').then(function () {
        console.log('done loading!');
      }).catch(function (err) {
        // HTTP error or something like that
      });
    };

    const getalldocs = () => {
        //var db = new pouchdb("alqs");
        db.allDocs({
          include_docs: true,
          attachments: true
        }).then(function (result) {
          result.rows.map(function(row) { console.log(row.doc); });
          //console.log(result.rows[0].doc);
          res.json({ "users": result.rows });
        }).catch(function (err) {
          console.log(err);
        });
      };

    const createdb = () => {
      db = new PouchDB('alqs', {
        auto_compaction: true
      });
      console.log('database created')
    };

    const deletedb = () => {
      db.destroy().then(function () {
        //debugger
        console.log('database destroyed')
      }).catch(function (err) {
        console.log('database ERROR Sdestroyed')
      })
    };

    const showTodos = () => {
      //debugger
      console.log('INSIDE showtodos')
      // var self = this;

      db.find({
        selector: {
          $and: [{
            last_name: {
              '$gt': null
            }
          }, // tip for sorting fiels
          {
            last_name: {
              $regex: "^" + searchkey
            }
          } // tip for match PI* like
          ]
        },
        //fields: ['_id', 'first_name', 'last_name','email'],
        sort: ['last_name']
      })
        .then(function (doc) {
          vitems = doc.docs;
          //debugger
          var arrx = doc.docs
          mesx = "11"
          for (var i = 0; i < arrx.length; i++) {
            //console.log("array index: " + i);
            var obj = arrx[i];
            for (var key in obj) {
              var value = obj[key];
              if (key == "alq" + mesx) {
                //console.log(key + ": " + value);
              }
              if (key == "abl" + mesx) {
                //console.log(key + ": " + value);
              }
            }
          }
          vitems = doc.docs;
          $update(); // very important vue like render in f7
        })
        .catch(function (err) {
          console.log(err)
        });
    };

    const createidx = () => {
      db.createIndex({
        index: {
          fields: ['last_name']
        }
      }).then(function (result) {
        console.log(result);
      }).catch(function (err) {
        console.log(err);
      });
    };

    const findrecs = () => {
      var self = this;
      //self.openAlert()
      console.log('***************');
      searchkey = ""
      showTodos()
      //$update();


    }

    //////////////////////////////////////////////////////////////
    /////////defined functions per page //////////////////////////
    //////////////////////////////////////////////////////////////

    $on('pageInit', () => {
      
      console.log('pageMounted');
      //debugger
      showTodos()

      const sync = () => {

        var opts = {
          live: true,
          retry: true
        };
        db.replicate.to(remoteCouch, opts, syncError);
        db.replicate.from(remoteCouch, opts, syncError);
      }
      // There was some form or error syncing
      const syncError = () => {
        console.log('error')
        //syncDom.setAttribute('data-sync-state', 'error');
      }

      if (remoteCouch) {
        //togle sync
        //sync();
      }

      // navbar link tooltip
      var navbarTooltip = app.tooltip.create({
        targetEl: '#bnw',
        text: 'One more tooltip<br>with more text<br><em>and custom formatting</em>'
      });
    });

    return $render;

  }
</script>