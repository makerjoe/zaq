<template>
  <div class="page" data-name="formMD">
    <div class="navbar">
      <div class="navbar-bg"></div>

      <div class="navbar-inner sliding">
        <div class="left">
          <a href="#" class="link back">
            <i class="icon icon-back"></i>
            <span class="ios-only">Back</span>
          </a>
        </div>
        <div class="title">CRUDstate ${listado} </div>
      </div>
    </div>
    <div class="page-content">
      <div class="block-title">About My App F7 : ${app.version} ${listado}</div>
      <div class="block block-strong">
        <div class="block">
          <div class="row">
            <button @click=${()=>openPopup(index,1)} class="col button button-fill">Add New</button>
            <button @click=${findrecs} class="col button button-fill">Search</button>
            <button @click=${createidx} class="col button button-fill">IDX</button>
            <button @click=${bulkrecs} class="col button button-fill button-round">Bulk</button>
            <button @click=${loadrecs} class="col button button-fill button-round">Load</button>
            <button @click=${getalldocs} class="col button button-fill button-round">GetDocs</button>
            <button @click=${deletedb} class="col button button-fill button-round">DeleteDB</button>
            <button @click=${createdb} class="col button button-fill button-round">CreateDB</button>
            <button id="testDB" class="col button button-fill button-round">TestDB</button>
          </div>
        </div>

        <!--         @click=${() => removerec($store.state.index)} -->
        <button @click=${()=> openAlert(15)}>Button</button>
        <button @click=${()=> openAlert2(25)}>Button</button>

        <button class="col button search">search</button>
        <div class="w3-container">

          <div id="id01" class="w3-modal w3-animate-opacity">
            <div class="w3-modal-content w3-card-4 " style="width:100%">
              <header class="w3-container w3-teal">

                <span @click=${changeattr} class="w3-button w3-large w3-display-topright">
                  X
                </span>

                <h2>Modal Header</h2>
              </header>
              <div class="w3-container">
                <h1>${listado}</h1>
                <p>Some text..</p>
                <span class="button" @click=${()=> removerec($store.state.index)}>Remove Record</span>
                <span class="button" @click=${()=> updaterec($store.state.index)}>Save Record</span>

                <footer class="w3-container w3-teal">
                  <p>Modal Footer</p>
                </footer>
              </div>
            </div>
          </div>
          <!-- Each "cells" row should be wrapped with div class="row" -->
          <div class="row">
            <!-- Each "cell" has col-[widht in percents] class -->
            <div class="col-100">

              <div class="list simple-list">
                <ul>

                  ${vitems.map((xvitem, index) => $h`
                  <li>
                    <a @click=${()=> openPopup(index)}>
                      ${index}--
                      ${xvitem.first_name}--
                      ${xvitem.last_name}--
                      ${xvitem.email}--
                    </a>
                  </li>
                  `)}

                </ul>

              </div>
            </div>

          </div>

          <p>Fugiat perspiciatis excepturi, soluta quod non ullam deleniti. Nobis sint nemo consequuntur, fugiat. Eius
            perferendis animi autem incidunt vel quod tenetur nostrum, voluptate omnis quasi quidem illum consequuntur,
            a, quisquam.</p>
          <p>Laudantium neque magnam vitae nemo quam commodi, in cum dolore obcaecati laborum, excepturi harum, optio
            qui, consequuntur? Obcaecati dolor sequi nesciunt culpa quia perspiciatis, reiciendis ex debitis, ut tenetur
            alias.</p>
        </div>
        <div class="block">
          <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Magni molestiae laudantium dignissimos est nobis
            delectus nemo ea alias voluptatum architecto, amet similique, saepe iste consectetur in repellat ut minus
            quibusdam!</p>
          <p>Molestias et distinctio porro nesciunt ratione similique, magni doloribus, rerum nobis, aliquam quae
            reiciendis quasi modi. Nam a recusandae, fugiat in ea voluptates fuga eius, velit corrupti reprehenderit
            dignissimos consequatur!</p>
          <p>Blanditiis, cumque quo adipisci. Molestiae, dolores dolorum quos doloremque ipsa ullam eligendi commodi
            deserunt doloribus inventore magni? Ea mollitia veniam nostrum nihil, iusto doloribus a at! Ea molestiae
            ullam delectus!</p>
        </div>
      </div>


      <div class="popup demo-popup">
        <div class="page">
          <div class="navbar">
            <div class="navbar-bg"></div>

            <div class="navbar-inner">
              <div class="title">Popup Title</div>
              <div class="right"><a href="#" class="link popup-close">Close</a>
              </div>
            </div>
          </div>
          <div class="page-content">
            <div class="block">
              <form class="list" id="my-form">
                <ul>
                  <li>
                    <div class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">id</div>
                        <div class="item-input-wrap">
                          <input type="text" name="_id" placeholder="ID" readonly />
                        </div>
                      </div>
                    </div>
                  </li>

                  <li>
                    <div class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">rev</div>
                        <div class="item-input-wrap">
                          <input type="text" name="_rev" placeholder="REV" readonly />
                        </div>
                      </div>
                    </div>
                  </li>

                  <li>
                    <div class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">Montos</div>
                        <div class="item-input-wrap">
                          <input type="text" name="montosx" placeholder="Montos" />
                        </div>
                      </div>
                    </div>
                  </li>
                  <li>
                    <div class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">FirstName</div>
                        <div class="item-input-wrap">
                          <input type="text" name="first_name" placeholder="Your name" />
                        </div>
                      </div>
                    </div>
                  </li>
                  <li>
                    <div class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">LastName</div>
                        <div class="item-input-wrap">
                          <input type="text" name="last_name" placeholder="Your name" />
                        </div>
                      </div>
                    </div>
                  </li>
                  <li>
                    <div class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">E-mail</div>
                        <div class="item-input-wrap">
                          <input type="email" name="email" placeholder="E-mail" />
                        </div>
                      </div>
                    </div>
                  </li>
                  <li>
                    <div class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">FiniAno</div>
                        <div class="item-input-wrap">
                          <input type="email" name="finiano" placeholder="E-mail" />
                        </div>
                      </div>
                    </div>
                  </li>
                  <li>
                    <div class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">FiniMes</div>
                        <div class="item-input-wrap">
                          <input type="email" name="finimes" placeholder="E-mail" />
                        </div>
                      </div>
                    </div>
                  </li>
                  <li>
                    <div class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">FiniDia</div>
                        <div class="item-input-wrap">
                          <input type="email" name="finidia" placeholder="E-mail" />
                        </div>
                      </div>
                    </div>
                  </li>
                  <li>
                    <div class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">Gender</div>
                        <div class="item-input-wrap">
                          <select name="gender">
                            <option value="male" selected>Male</option>
                            <option value="female">Female</option>
                          </select>
                        </div>
                      </div>
                    </div>
                  </li>
                  <li>
                    <div class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">Gender</div>
                        <div class="item-input-wrap">
                          <select name="gender">
                            <option value="male" selected>Male</option>
                            <option value="female">Female</option>
                          </select>
                        </div>
                      </div>
                    </div>
                  </li>
                  <li>
                    <div class="item-content">
                      <div class="item-inner">
                        <div class="item-title">Toggle</div>
                        <div class="item-after">
                          <label class="toggle toggle-init">
                            <input type="checkbox" name="toggle" value="yes" /><i class="toggle-icon"></i>
                          </label>
                        </div>
                      </div>
                    </div>
                  </li>
                </ul>
                <div id='formarrx'></div>
              </form>

              <p>Some text..</p>
              <span class="button" @click=${()=> removerec($store.state.index)}>Remove Record</span>
              <span class="button" @click=${()=> updaterec($store.state.index)}>Save Record</span>

              <p class="">Here comes popup. You can put here anything, even independent view with its own navigation.
                Also not, that by default popup looks a bit different on iPhone/iPod and iPad, on iPhone it is
                fullscreen.</p>
              <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Suspendisse faucibus mauris leo, eu bibendum
                neque congue non. Ut leo mauris, eleifend eu commodo a, egestas ac urna. Maecenas in lacus faucibus,
                viverra ipsum pulvinar, molestie arcu. Etiam lacinia venenatis dignissim. Suspendisse non nisl semper
                tellus malesuada suscipit eu et eros. Nulla eu enim quis quam elementum vulputate. Mauris ornare
                consequat nunc viverra pellentesque. Aenean semper eu massa sit amet aliquam. Integer et neque sed
                libero mollis elementum at vitae ligula. Vestibulum pharetra sed libero sed porttitor. Suspendisse a
                faucibus lectus.</p>
              <p>Duis ut mauris sollicitudin, venenatis nisi sed, luctus ligula. Phasellus blandit nisl ut lorem semper
                pharetra. Nullam tortor nibh, suscipit in consequat vel, feugiat sed quam. Nam risus libero, auctor vel
                tristique ac, malesuada ut ante. Sed molestie, est in eleifend sagittis, leo tortor ullamcorper erat, at
                vulputate eros sapien nec libero. Mauris dapibus laoreet nibh quis bibendum. Fusce dolor sem, suscipit
                in iaculis id, pharetra at urna. Pellentesque tempor congue massa quis faucibus. Vestibulum nunc eros,
                convallis blandit dui sit amet, gravida adipiscing libero.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>
<script>
  export default (props, { $f7, $on, $store, $update }) => {
    // -------------------------------------------------------

    // Component Data
    var $ = Dom7;
    var vitems = $store.state.vitems;
    var alqsdata = $store.state.alqsdata;
    //debugger
    var listado = 'Datos de Inquilino';
    //var index = 0;

    console.log('init comp');
    //debugger

    const changeattr = () => {
      console.log('init chgattr');
      document.getElementById('id01').style.display = 'none'
    };

    const openAlert = (xxx) => {
      //debugger;
      var self = this;
      //app.dialog.alert(xxx);
      self.$app.dialog.alert(app.version);
      listado = xxx
      $update();
    };

    const openAlert3 = (xxx) => {
      var self = this;
      db.compact().then(function (info) {
        self.$app.dialog.alert(xxx);
        // compaction complete
      }).catch(function (err) {
        // handle errors
      });
    };

    const openPopup = (index,rec) => {
      //debugger;
      //console.log(this.vitems[index])

      if (rec) {

        //_id: new Date().toISOString(),

        record = {
                  "_id": new Date().toISOString(),
                  "address": "Martires Palotinos 4041 depto 0000",
                  "fechaini": [2018, 3, 1],
                  "finiano": "2018",
                  "finimes": "3",
                  "finidia": "1",
                  "duracion": 2,
                  "tasa": 21,
                  "first_name": "Miguel",
                  "last_name": "Angel000",
                  "email": "cstimson0@seesaa.net",
                  "gender": "Female",
                  "ip_address": "129.251.46.64",
                  "montosx": "9999",

                  "alq0": 0, "alq1": 0, "alq2": 0, "alq3": 0, "alq4": 0, "alq5": 0, "alq6": 0, "alq7": 0, "alq8": 0, "alq9": 0, "alq10": 0, "alq11": 12, "alq12": 0, "alq13": 0, "alq14": 0, "alq15": 0, "alq16": 0, "alq17": 0, "alq18": 0, "alq19": 0, "alq20": 0, "alq21": 0, "alq22": 0, "alq23": 24,
                  "abl0": 0, "abl1": 0, "abl2": 0, "abl3": 0, "abl4": 0, "abl5": 0, "abl6": 0, "abl7": 0, "abl8": 0, "abl9": 0, "abl10": 0, "abl11": 12, "abl12": 0, "abl13": 0, "abl14": 0, "abl15": 0, "abl16": 0, "abl17": 0, "abl18": 0, "abl19": 0, "abl20": 0, "abl21": 0, "abl22": 0, "abl23": 24,
                  "ays0": 0, "ays1": 0, "ays2": 0, "ays3": 0, "ays4": 0, "ays5": 0, "ays6": 0, "ays7": 0, "ays8": 0, "ays9": 0, "ays10": 0, "ays11": 12, "ays12": 0, "ays13": 0, "ays14": 0, "ays15": 0, "ays16": 0, "ays17": 0, "ays18": 0, "ays19": 0, "ays20": 0, "ays21": 0, "ays22": 0, "ays23": 24,
                  "hon0": 0, "hon1": 0, "hon2": 0, "hon3": 0, "hon4": 0, "hon5": 0, "hon6": 0, "hon7": 0, "hon8": 0, "hon9": 0, "hon10": 0, "hon11": 12, "hon12": 0, "hon13": 0, "hon14": 0, "hon15": 0, "hon16": 0, "hon17": 0, "hon18": 0, "hon19": 0, "hon20": 0, "hon21": 0, "hon22": 0, "hon23": 24,
                  "imb0": 0, "imb1": 0, "imb2": 0, "imb3": 0, "imb4": 0, "imb5": 0, "imb6": 0, "imb7": 0, "imb8": 0, "imb9": 0, "imb10": 0, "imb11": 12, "imb12": 0, "imb13": 0, "imb14": 0, "imb15": 0, "imb16": 0, "imb17": 0, "imb18": 0, "imb19": 0, "imb20": 0, "imb21": 0, "imb22": 0, "imb23": 24,
                  "fix0": 0, "fix1": 0, "fix2": 0, "fix3": 0, "fix4": 0, "fix5": 0, "fix6": 0, "fix7": 0, "fix8": 0, "fix9": 0, "fix10": 0, "fix11": 12, "fix12": 0, "fix13": 0, "fix14": 0, "fix15": 0, "fix16": 0, "fix17": 0, "fix18": 0, "fix19": 0, "fix20": 0, "fix21": 0, "fix22": 0, "fix23": 24

                }

      } else {
        record = vitems[index]
      }

      function textBoxCreate(d) {

        output = '';
        output += '<div class="card data-table  data-table-init">'
        output += '<div class="card-content">'
        output += '<table>'
        output += '<thead>'
        output += '<tr>'
        output += '<th class="label-cell">Year</th>'
        output += '<th class="numeric-cell">Month</th>'
        output += '<th class="numeric-cell">ALQS</th>'
        output += '<th class="numeric-cell">AYSS</th>'
        output += '<th class="numeric-cell">ABLS</th>'
        output += '<th class="numeric-cell">HONS</th>'
        output += '<th class="numeric-cell">IMBS</th>'
        output += '<th class="numeric-cell">FIXS</th>'
        output += '</tr>'
        output += '</thead>'

        output += '<tbody>'

        for (ii = 0; ii < 24; ++ii) {
          mes = textomes[d.getMonth()]

          output += '<tr>'
          output += '<td class="label-cell">'
          output += d.getFullYear() + '/' + (d.getMonth() + 1)
          output += '</td>'
          output += '<td class="numeric-cell">'
          output += '  ' + mes + '/' + ii
          output += '</td>'

          d.setMonth(d.getMonth() + 1);

          output += '<td class="numeric-cell">'
          output += '<input style="display: inline;width: 10 px;border: 1px solid #cfcfcf;" type="text" name="alq' + ii + '" placeholder="ALQS">'
          output += '</td>'
          output += '<td class="numeric-cell">'
          output += '<input style="display: inline;width: 10 px;border: 1px solid #cfcfcf;" type="text" name="ays' + ii + '" placeholder="AYSS">'
          output += '</td>'
          output += '<td class="numeric-cell">'
          output += '<input style="display: inline;width: 10 px;border: 1px solid #cfcfcf;" type="text" name="abl' + ii + '" placeholder="ABLS">'
          output += '</td>'
          output += '<td class="numeric-cell">'
          output += '<input style="display: inline;width: 10 px;border: 1px solid #cfcfcf;" type="text" name="hon' + ii + '" placeholder="HONS">'
          output += '</td>'
          output += '<td class="numeric-cell">'
          output += '<input style="display: inline;width: 10 px;border: 1px solid #cfcfcf;" type="text" name="imb' + ii + '" placeholder="IMBS">'
          output += '</td>'
          output += '<td class="numeric-cell">'
          output += '<input style="display: inline;width: 10 px;border: 1px solid #cfcfcf;" type="text" name="fix' + ii + '" placeholder="FIXS">'
          output += '</td>'
          output += '</tr>'
        }

        output += '</tbody>'
        output += '</table>'
        output += '</div>'
        output += '</div>'
      };

      //alert(JSON.stringify(index));
      //recindex = index
      //fini = record.fechaini;

      finiano = record.finiano;
      finimes = record.finimes;
      finidia = record.finidia;
      fini = finiano + ',' + finimes + ',' + finidia

      console.log(record)
      //console.log(index.montosx)
      //index.montosx = index.montos.alq[23]
      //console.log(index.montosx)

      var d = new Date(fini); //ymd julio (7) = 6
      textBoxCreate(d)
      //debugger
      document.getElementById('formarrx').innerHTML = output;
      //app.form.fillFromData('#my-form', record);


      // Create dynamic Popup
      var dynamicPopup = app.popup.create({
        el: '.demo-popup',
        // Events
        on: {
          open: function (popup) {
            console.log(popup);
            document.getElementById('formarrx').innerHTML = output;
            app.form.fillFromData('#my-form', record);

          },
          opened: function (popup) {
            console.log('Popup opened');
          },
        }
      });

      dynamicPopup.open();
    };



    const openAlert4 = (xxx) => {
      //debugger;
      var self = this;
      //app.dialog.alert(xxx);
      self.$app.dialog.alert(app.version);
      self.$setState({
        listado: 'changing state',
      })
    };

    const openAlert2 = (xxx) => {
      var self = this;
      db.compact().then(function (info) {
        self.$app.dialog.alert(xxx);
        // compaction complete
      }).catch(function (err) {
        // handle errors
      });
    };

    const updaterec = (index) => {
      //index= $store.state.index;
      console.log('Updating record', index)
      recindex = vitems[index]
      var formData = app.form.convertToData('#my-form');
      //alert(JSON.stringify(formData));
      var index = _.merge(recindex, formData);
      console.log(index, 'recindex')
      db.put(index);
      showTodos()
      document.getElementById('id01').style.display = 'none'
    };

    const removerec = (indexxx) => {
      var formData = app.form.convertToData('#my-form');
      console.log(formData)
      index = formData;
      //var self = this;
      //self.$app.dialog.alert(JSON.stringify(index));
      db.remove(index);
      //db.remove(index._id, index._rev);
      showTodos();
      document.getElementById('id01').style.display = 'none'
    };

    const newrec = () => {
      document.getElementById("my-form").reset();
      var formData = {
        _id: new Date().toISOString(),
      }
      app.form.fillFromData('#my-form', formData);
      document.getElementById('id01').style.display = 'none'
    };

    const bulkrecs = () => {
      db.bulkDocs(alqsdata).then(function (result) {
        // handle result
        console.log('bulk data has  been loaded', result);
      }).catch(function (err) {
        console.log(err);
      });
    };


    const loadrecs = () => {
      var db = new PouchDB('alqs');
      db.load('./dump.txt').then(function () {
        console.log('done loading!');
      }).catch(function (err) {
        // HTTP error or something like that
      });
    };

    const getalldocs = () => {
      //var db = new pouchdb("alqs");
      db.allDocs({
        include_docs: true,
        attachments: true
      }).then(function (result) {
        result.rows.map(function (row) { console.log(row.doc); });
        //console.log(result.rows[0].doc);
        res.json({ "users": result.rows });
      }).catch(function (err) {
        console.log(err);
      });
    };

    const createdb = () => {
      db = new PouchDB('alqs', {
        auto_compaction: true
      });
      console.log('database created')
    };

    const deletedb = () => {
      db.destroy().then(function () {
        //debugger
        console.log('database destroyed')
      }).catch(function (err) {
        console.log('database ERROR Sdestroyed')
      })
    };

    const showTodos = () => {
      //debugger
      console.log('INSIDE showtodos')
      // var self = this;

      db.find({
        selector: {
          $and: [{
            last_name: {
              '$gt': null
            }
          }, // tip for sorting fiels
          {
            last_name: {
              $regex: "^" + searchkey
            }
          } // tip for match PI* like
          ]
        },
        //fields: ['_id', 'first_name', 'last_name','email'],
        sort: ['last_name']
      })
        .then(function (doc) {
          vitems = doc.docs;
          //debugger
          var arrx = doc.docs
          mesx = "11"
          for (var i = 0; i < arrx.length; i++) {
            //console.log("array index: " + i);
            var obj = arrx[i];
            for (var key in obj) {
              var value = obj[key];
              if (key == "alq" + mesx) {
                //console.log(key + ": " + value);
              }
              if (key == "abl" + mesx) {
                //console.log(key + ": " + value);
              }
            }
          }
          vitems = doc.docs;
          $update(); // very important vue like render in f7
        })
        .catch(function (err) {
          console.log(err)
        });
    };

    const createidx = () => {
      db.createIndex({
        index: {
          fields: ['last_name']
        }
      }).then(function (result) {
        console.log(result);
      }).catch(function (err) {
        console.log(err);
      });
    };

    const findrecs = () => {
      var self = this;
      //self.openAlert()
      console.log('***************');
      searchkey = ""
      showTodos()

    };

    const findrec = () => {
      //var self = this;
      //self.openAlert()
      console.log('***************');
      searchkey = ""
      showTodos()

    };

    //////////////////////////////////////////////////////////////
    /////////defined functions per page //////////////////////////
    //////////////////////////////////////////////////////////////

    $on('pageInit', () => {
      console.log('pageMounted');
      //debugger
      showTodos()

      const sync = () => {

        var opts = {
          live: true,
          retry: true
        };
        db.replicate.to(remoteCouch, opts, syncError);
        db.replicate.from(remoteCouch, opts, syncError);
      }

      // There was some form or error syncing
      const syncError = () => {
        console.log('error')
        //syncDom.setAttribute('data-sync-state', 'error');
      }

      if (remoteCouch) {
        //togle sync
        //sync();
      }

      // navbar link tooltip
      var navbarTooltip = app.tooltip.create({
        targetEl: '#bnw',
        text: 'One more tooltip<br>with more text<br><em>and custom formatting</em>'
      });

      const xx ='2222'
      $('#testDB').on('click', (xx) => {
        console.log('object testDB', xx );
      });

    });

    return $render;

  }
</script>